<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Entropy and pixi.js Bunnymark</title>
    <style>
        body {
            background: black;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
    </div>
    <p style="color: white;">
        Bunnies count: <span id="bunnies-count">0</span><br />
        FPS: <span id="fps"></span>
    </p>
    <script src="../lib/pixi.min.js"></script>
    <script src="../lib/memory-stats.js"></script>
    <script src="../../build/entropy.js"></script>
    <script src="../../build/entropy-plugins.js"></script>
    <script>
        /*
         * STATES
         */
        var stage, renderer, game;

        Entropy.State({
            name: "initialize",
            initialize: function (game, done) {
                Entropy.Const("WIDTH", 600);
                Entropy.Const("HEIGHT", 400);
                Entropy.Const("GRAVITY", 200);

                var interactive = false;
                stage = new PIXI.Stage(0xffffff, interactive);
                renderer = new PIXI.autoDetectRenderer(Entropy.WIDTH, Entropy.HEIGHT, null, false, true);

                var canvasContainer = document.getElementById("canvas-container");
                canvasContainer.appendChild(renderer.view);
                var bunniesCount = document.getElementById("bunnies-count");
                var bunnyTexture = new PIXI.Texture.fromImage("img/bunny.png");
                var bunnyAdder;

                canvasContainer.addEventListener("mousedown", function () {
                    clearInterval(bunnyAdder);
                    var bunnyAdderFn = function () {
                        for (var i = 0; i < 50; i++) {
                            game.engine.create("Bunny", bunnyTexture);
                        }

                        bunniesCount.innerText = game.engine._entitiesCount;

                        bunnyAdder = setTimeout(bunnyAdderFn, 1);
                    }

                    bunnyAdderFn()
                });

                canvasContainer.addEventListener("mouseup", function () {
                    clearTimeout(bunnyAdder);
                });

                done();
            },
            enter: function (game, done) {
                game.engine.addSystem(["Render", 0]);
                game.engine.addSystem(["BunnyMovement", 1], document.getElementById("fps"));
                //game.engine.addSystem(["SpritePositionUpdater", 2]);

                game.start();
                game.ticker.debug(true)
                done();
            }
        });


        Entropy.Component({
            name: "Position",
            initialize: function (x, y) {
                this.x = x;
                this.y = y;
            }
        });

        Entropy.Component({
            name: "Velocity",
            initialize: function (vx, vy) {
                this.vx = vx;
                this.vy = vy;
            }
        });

        Entropy.Component({
            name: "Sprite",
            initialize: function (sprite) {
                this.sprite = sprite;
            }
        });

        Entropy.Entity({
            name: "Bunny",
            create: function (game, bunnyTexture) {
                var sprite = new PIXI.Sprite(bunnyTexture);
                
                sprite.position.x = 50;
                sprite.position.y = 50;
                sprite.anchor.x = 0.5;
                sprite.anchor.y = 1;
                
                stage.addChild(sprite);

                this.add("Position", 50, 50)
                    .add("Velocity", Math.round(Math.random() * 150), Math.round(Math.random() * 150))
                    .add("Sprite", sprite);
            }
        });


        Entropy.System({
            name: "BunnyMovement",
            initialize: function (fps) {
                this.fpsContainer = fps;
                this.query = new Entropy.Engine.Query({name: 'Bunny'});
            },
            update: function (delta) {
                this.fpsContainer.innerText = this.game.ticker.getCurrentFPS();
                var bunnies = this.engine.getEntities(this.query);

                var bunny, e;
                var i = 0;

                while (e = bunnies[i]) {
                    var bunny = e.components;

                    //update position
                    bunny.position.x += delta / 1000 * bunny.velocity.vx;
                    bunny.position.y += delta / 1000 * bunny.velocity.vy;

                    //add gravity
                    bunny.velocity.vy += delta / 1000 * Entropy.GRAVITY;

                    //bounce!
                    if (bunny.position.x < 0) {
                        bunny.position.x = 0;
                        bunny.velocity.vx *= -1;
                    }

                    if (bunny.position.x > Entropy.WIDTH) {
                        bunny.position.x = Entropy.WIDTH;
                        bunny.velocity.vx *= -1;
                    }

                    if (bunny.position.y > Entropy.HEIGHT) {
                        bunny.position.y = Entropy.HEIGHT;

                        bunny.velocity.vy*= -1;
                    }

                    bunny.sprite.sprite.position.x = bunny.position.x;
                    bunny.sprite.sprite.position.y = bunny.position.y;

                    i++;
                }

            }
        });
        
        Entropy.System({
            name: "SpritePositionUpdater",
            initialize: function () {
                this.query = new Entropy.Query(['Position', 'Sprite']);
            },
            update: function (delta, event) {
                ///var sprites = this.engine.getEntitiesWith(["Sprite", "Position"]);
                var sprites = this.engine.getEntities(this.query);
                var e, sprite, position;

                var i = 0;

                while (e = sprites[i]) {
                    sprite = e.components.sprite;
                    position = e.components.position;

                    sprite.sprite.position.x = position.x;
                    sprite.sprite.position.y = position.y;

                    i++;
                }
            }
        });

        Entropy.System({
            name: "Render",
            initialize: function () {
                this.stage = stage;
                this.renderer = renderer;
                var stats = new MemoryStats();

                stats.domElement.style.position = 'fixed';
                stats.domElement.style.right        = '0px';
                stats.domElement.style.bottom       = '0px';

                document.body.appendChild( stats.domElement );

                this.stats = stats;
            },
            update: function (delta, event) {
                this.renderer.render(this.stage);
                this.stats.update();
            }
        });

        window.addEventListener("load", function () {
            game = new Entropy.Game("initialize");
        }, false);

    </script>
</body>
</html>