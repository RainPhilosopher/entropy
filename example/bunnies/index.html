<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Entropy and pixi.js Bunnymark</title>
    <style>
        body {
            background: black;
        }

        canvas {
            background-color: white;
        }

        p {
            color: white;
        }
    </style>
</head>
<body>
    <p>
        Click on canvas to add bunnies.
    </p>
    <div id="canvas-container">
        <canvas></canvas>
    </div>
    <p>
        Bunnies count: <span id="bunnies-count">0</span><br />
    </p>
    <script src="../lib/pixi.min.js"></script>
    <script src="../lib/memory-stats.js"></script>
    <script src="../../build/entropy.js"></script>
    <script>
        //some globals, this is bad practice but in this simple example we can do that
        var stage, renderer, game;

        Entropy.State({
            name: "initialize",
            initialize: function (game, done) {
                Entropy.Const("WIDTH", 600);
                Entropy.Const("HEIGHT", 400);
                Entropy.Const("GRAVITY", 200);

                var view = document.getElementsByTagName("canvas")[0];

                renderer = new PIXI.autoDetectRenderer(Entropy.WIDTH, Entropy.HEIGHT, {
                    view: view,
                    transparent: true,
                    antialias: false
                });

                stage = new PIXI.Container();

                var bunniesCount = document.getElementById("bunnies-count");
                var bunnyTexture = new PIXI.Texture.fromImage("img/bunny.png");
                var bunnyAdder;

                view.addEventListener("mousedown", function (e) {
                    var bunnyAdderFn = function () {
                        for (var i = 0; i < 50; i++) {
                            game.engine.create("Bunny", e.offsetX, e.offsetY, bunnyTexture);
                        }

                        bunniesCount.innerText = game.engine._entitiesCount;

                        bunnyAdder = setTimeout(bunnyAdderFn, 1);
                    }

                    bunnyAdderFn()
                });

                view.addEventListener("mouseup", function () {
                    clearTimeout(bunnyAdder);
                });

                return done();
            },
            enter: function (game, done) {
                game.engine.addSystem(["Render", 0]);
                game.engine.addSystem(["BunnyMovement", 1]);

                game.start();

                //turn on ticker debugger (little window with FPS in top-right corner)
                game.ticker.debug(true)

                return done();
            }
        });

        Entropy.Component({
            name: "Position",
            initialize: function (x, y) {
                this.x = x;
                this.y = y;
            }
        });

        Entropy.Component({
            name: "Velocity",
            initialize: function (vx, vy) {
                this.vx = vx;
                this.vy = vy;
            }
        });

        Entropy.Component({
            name: "Sprite",
            initialize: function (sprite) {
                this.sprite = sprite;
            }
        });

        Entropy.Entity({
            name: "Bunny",
            create: function (game, x, y, bunnyTexture) {
                var sprite = new PIXI.Sprite(bunnyTexture);
                
                sprite.position.x = x;
                sprite.position.y = y;
                sprite.anchor.x = 0.5;
                sprite.anchor.y = 0.5;
                
                stage.addChild(sprite);

                this.add("Position", x, y)
                    .add("Velocity", Math.round(Math.random() * 150), Math.round(Math.random() * 150))
                    .add("Sprite", sprite);
            }
        });


        Entropy.System({
            name: "BunnyMovement",
            initialize: function () {
                this.query = new Entropy.Query({
                    name: 'Bunny'
                });
            },
            update: function (delta) {
                var bunnies = this.engine.getEntities(this.query);

                var bunny, e;
                var i = 0;

                while (e = bunnies[i]) {
                    var bunny = e.components;

                    //update position
                    bunny.position.x += delta / 1000 * bunny.velocity.vx;
                    bunny.position.y += delta / 1000 * bunny.velocity.vy;

                    //bounce!
                    if (bunny.position.x < 0) {
                        bunny.position.x = 0;
                        bunny.velocity.vx *= -1;
                    }

                    if (bunny.position.x > Entropy.WIDTH) {
                        bunny.position.x = Entropy.WIDTH;
                        bunny.velocity.vx *= -1;
                    }

                    if (bunny.position.y > Entropy.HEIGHT) {
                        bunny.position.y = Entropy.HEIGHT;

                        bunny.velocity.vy*= -1;
                    }
                    
                    //add gravity
                    bunny.velocity.vy += delta / 1000 * Entropy.GRAVITY;

                    bunny.sprite.sprite.position.x = bunny.position.x;
                    bunny.sprite.sprite.position.y = bunny.position.y;

                    i++;
                }
            }
        });

        Entropy.System({
            name: "Render",
            update: function (delta) {
                renderer.render(stage);
            }
        });

        window.addEventListener("load", function () {
            game = new Entropy.Game("initialize");
        }, false);
    </script>
</body>
</html>
