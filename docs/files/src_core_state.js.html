<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\core\state.js - Entropy</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Entropy" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Engine.html">Engine</a></li>
                                <li><a href="../classes/Entity.html">Entity</a></li>
                                <li><a href="../classes/Entropy.html">Entropy</a></li>
                                <li><a href="../classes/Game.html">Game</a></li>
                                <li><a href="../classes/Pool.html">Pool</a></li>
                                <li><a href="../classes/Query.html">Query</a></li>
                                <li><a href="../classes/State.html">State</a></li>
                                <li><a href="../classes/Ticker.html">Ticker</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Entropy.html">Entropy</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\core\state.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var is = require(&#x27;check-types&#x27;);
var slice = Array.prototype.slice;
var states = [];

/**
 * This class is an implementation of simple state manager.
 *
 * @class State
 * @param {Game} game Game instance
 */
function State(game) {
    var queue = [];
    var current = {
        transitions: {}
    };

    var shifting = false;

    var shift = function () {
        var queueHead = queue.shift();

        if (queueHead == null) {
            shifting = false;
            return;
        }

        shifting = true;

        var fn = queueHead.fn;
        var binding = queueHead.binding;
        var args = queueHead.args || [];

        args.push(next);

        fn.apply(binding, args);
    };

    var next = function () {
        shift();
    };

    var setCurrentState = function (state, done) {
        current = state;
        return done();
    };

    var setInitialized = function (state, done) {
        state._initialized = true;
        return done();
    };

    var initializeState = function (state, done) {
        if (is.function(state.initialize)) {
            return state.initialize(game, done);
        }

        return done();
    };

    var enterState = function (state, done) {
        if (is.function(state.enter)) {
            return state.enter(game, done);
        }

        return done();
    };

    var exitState = function (done) {
        if (is.function(current.exit)) {
            return current.exit(game, done);
        }

        return done();
    };

    var doTransition = function (to, next) {
        var args = slice.call(arguments, 2);

        if (to in current.transitions) {
            var transFn = current[current.transitions[to]];

            return transFn.apply(current, [game, next].concat(args));
        }

        var done = args.pop();

        return done();
    };

    /**
     * Changes state to one identified by &#x60;name&#x60; parameter.
     * Changing state process looks roughly like this:
     *  1. calling current state&#x27;s &#x60;exit&#x60; method (if present)
     *  2. calling next state&#x27;s &#x60;initialize&#x60; method (if present)
     *  3. calling transition function (if present)
     *  4. calling next state&#x27;s &#x60;enter&#x60; method (if present)
     * 
     * @method change
     * @chainable
     * @param  {String} ...name state to change into. Any addidtional parameter will be applied to transition method.
     * @return {State}          State instance
     */
    this.change = function (name) {
        if (!is.string(name) || !(name in states)) {
            console.warn(&#x27;State %s does not exists - change will not occur.&#x27;, name);
            return;
        }

        var args = slice.call(arguments, 1);
        var next = states[name];

        if (next.manager == null) {
            next.manager = this;
        }

        queue.push({
            fn: exitState
        });

        if (!next._initialized) {
            queue.push({
                fn: initializeState,
                args: [next]
            });

            queue.push({
                fn: setInitialized,
                args: [next]
            });
        }

        queue.push({
            fn: doTransition,
            args: [name, next].concat(args)
        });

        queue.push({
            fn: enterState,
            args: [next]
        });

        queue.push({
            fn: setCurrentState,
            args: [next]
        });

        if (!shifting) {
            return shift();
        }
    };

    /**
     * Returns name of the current state.
     * 
     * @method current
     * @return {String} name of the current state
     */
    this.current = function () {
        return current.name;
    };

    /**
     * Checks whether state machine is in state identified by name.
     * 
     * @method isIn
     * @param  {String}  state states name
     * @return {Boolean}
     */
    this.isIn = function (state) {
        return state === current.name;
    };

    this.feed = function (state) {
        return this.register(state);
    };

    this.register = function (state) {
        if (!is.object(state)) {
            return console.warn(&#x27;Registered state must be an object.&#x27;);
        }

        if (!(&#x27;transitions&#x27; in state)) {
            state.transitions = {};
        }

        state._initialized = false;
        state.manager = this;
        states[state.name] = state;

        return this;
    };
}

/**
 * Registers new state.
 * 
 * @static
 * @method Register
 * @param {Object} state state object (see example)
 */
State.Register = function (state) {
    if (!is.object(state)) {
        return debug.warn(&#x27;Registered state must be an object.&#x27;);
    }

    if (!(&#x27;transitions&#x27; in state)) {
        state.transitions = {};
    }

    state._initialized = false;
    states[state.name] = state;
}

module.exports = State;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
